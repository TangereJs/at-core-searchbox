<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../layout/layout.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">
<link rel="import" href="../at-core-mic/at-core-mic.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">

<dom-module id="at-core-searchbox">
    <style>
      :host {
        display: block;
      }
      
      #searchBox {
        background-color: white;
        position: relative;       
        height: 44px;
        padding: 0 4px;
        border: 1px solid rgba(0, 0, 0, 0.16);
        margin:0 auto;
        max-width:500px;
      }
      
      #searchInput {
        margin: 0 1px;
        border: 0;
        font-size: 16px;
        outline: none;
      }
      
      #searchIcon {
        padding-left: 4px;
      }
      
    </style>
    <template>
        <at-core-theme></at-core-theme>
        <form action="#" method="get" onsubmit="event.preventDefault()">
            <div id="searchBox" class="layout center horizontal">
                <at-carbon-icon id="searchIcon" icon="search"></at-carbon-icon>
                <input id="searchInput" class="flex" on-blur="termChange" on-keypress="keyPress" value="{{searchTermValue}}" type="search" placeholder="{{placeholder}}" />
                <at-core-mic id="speech" language="{{language}}"></at-core-mic>
            </div>
        </form>
    </template>
</dom-module>
  <script>

    Polymer({
        is: 'at-core-searchbox',
        _scopeCssViaAttr: true,
        properties: {     
            searchTermValue: { 
                type: String, 
                value: ''
            },
            searchTerm: { 
                type: String, 
                value: '', 
                reflect: true,
                notify: true
            },
            placeholder: { 
                type: String, 
                value: '',
                reflect: true 
            },
            language: { 
                type: String, 
                value: 'en-US', 
                reflect: true
            }
        },
        
        observers:[
            'searchTermChanged(searchTerm)'    
        ],
      
      keyPress: function(e) {
        // enter was hit
        if(e.keyCode == 13)  {
            this.termChange();
        }
      },
      
      searchTermChanged: function() {
        if(this.searchTermValue != this.searchTerm)  this.searchTermValue = this.searchTerm;
      },
        
      termChange: function () {
        this.$.searchInput.blur();
        this.searchTermValue = this.$.searchInput.value;
          
          
        this.searchTerm = this.searchTermValue;
      },
      
      ready: function() {
          this.addEventListener('at-core-mic-result', function(e) {
                this.searchTermValue = e.detail.transcript;              
                if(e.detail.isFinal) { this.termChange(); } 
            });
      }

    });

  </script>